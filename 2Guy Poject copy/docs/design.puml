@startuml

' PRESENTATION 
package presentation {
  note as SSENote
    Dashboards and notification views
    use a RefreshStrategy together with
    Server-Sent Events (SSE) so that
    grades, attendance, health, and
    discipline updates appear without
    manual refresh when DomainEventBus
    publishes new events.
  end note

  ' Views (MVC)
  class StudentParentDashboardView {
    +showDashboard(vm)
    +showError(message)
  }

  class TeacherGradebookView {
    +showGradebook(vm)
    +showSuccess(message)
    +showError(message)
  }

  class AttendanceView {
    +showAttendance(vm)
    +showError(message)
  }

  class HealthView {
    +showHealth(vm)
    +showError(message)
  }

  class DisciplineView {
    +showDiscipline(vm)
    +showError(message)
  }

  class LoginView {
    +showLogin()
    +showLoginError(message)
  }

  class NotificationView {
    +showNotifications(vm)
    +showError(message)
  }

  '  Controllers (MVC)
  class DashboardController {
    +loadStudentDashboard(studentId)
    +loadParentDashboard(parentId)
  }

  class GradebookController {
    +viewGradebook(sectionId, teacherId)
    +updateGrade(assignmentId, studentId, points, comment)
    +addFeedback(studentId, sectionId, comment)
  }

  class AttendanceController {
    +viewAttendance(studentId)
    +markAttendance(sectionId, studentId, date, status)
  }

  class HealthController {
    +viewHealthVisits(studentId)
    +recordVisit(studentId, nurseId, notes)
  }

  class DisciplineController {
    +viewDiscipline(studentId)
    +recordDiscipline(studentId, adminId, action, notes)
  }

  class SearchController {
    +search(criteria, strategyKind)
  }

  class ExportController {
    +exportReport(reportType, exportKind)
  }

  class AuthController {
    +login(username, password)
    +logout()
  }

  class NotificationController {
    +listNotifications(userId)
    +markNotificationRead(notificationId)
  }

  interface RefreshStrategy {
    +refresh(view, controller)
  }

  class PushRefreshStrategy {
    +refresh(view, controller)
  }

  class PollingRefreshStrategy {
    +refresh(view, controller)
  }

  ' ViewModels (Models in MVC) 
  class DashboardViewModel {
    +studentName: String
    +classesSummary: String
    +gradesSummary: String
    +attendanceSummary: String
    +feedbackSummary: String
    +disciplineSummary: String
    +healthSummary: String
  }

  class GradebookViewModel {
    +sectionName: String
    +assignmentsSummary: String
    +studentGradesSummary: String
  }

  class AttendanceViewModel {
    +studentName: String
    +recordsSummary: String
  }

  class HealthViewModel {
    +studentName: String
    +visitsSummary: String
  }

  class DisciplineViewModel {
    +studentName: String
    +actionsSummary: String
  }

  class NotificationViewModel {
    +notificationsSummary: String
  }

  SSENote .. DashboardController
}

' DOMAIN 
package domain {

  ' Core Users / Roles 
  class User {
    +id: String
    +username: String
    +passwordHash: String
    +role: String
  }

  class Student {
    +id: String
    +name: String
  }

  class Parent {
    +id: String
    +name: String
  }

  class Teacher {
    +id: String
    +name: String
  }

  class Nurse {
    +id: String
    +name: String
  }

  class Administrator {
    +id: String
    +name: String
  }

  class ParentStudentLink {
    +parentId: String
    +studentId: String
    +relationship: String
  }

  class Session {
    +token: String
    +userId: String
    +expiresAt: String
  }

  ' School Structure 
  class Class {
    +id: String
    +name: String
    +subject: String
  }

  class Section {
    +id: String
    +classId: String
    +teacherId: String
    +term: String
  }

  class Enrollment {
    +studentId: String
    +sectionId: String
  }

  ' Grades & Feedback 
  class Assignment {
    +id: String
    +sectionId: String
    +title: String
    +maxPoints: Double
    +dueDate: String
  }

  class GradeEntry {
    +id: String
    +assignmentId: String
    +studentId: String
    +points: Double
    +comment: String
  }

  class Feedback {
    +id: String
    +studentId: String
    +sectionId: String
    +teacherId: String
    +comment: String
    +createdAt: String
  }

  ' Attendance / Health / Discipline
  class AttendanceRecord {
    +id: String
    +studentId: String
    +sectionId: String
    +date: String
    +status: String
    +reason: String
  }

  class NurseVisit {
    +id: String
    +studentId: String
    +nurseId: String
    +visitTime: String
    +notes: String
  }

  class DisciplineAction {
    +id: String
    +studentId: String
    +adminId: String
    +date: String
    +actionType: String
    +notes: String
  }

  class Notification {
    +id: String
    +userId: String
    +type: String
    +message: String
    +read: Boolean
    +createdAt: String
  }

  class RolePermission {
    +role: String
    +permission: String
  }

  ' Domain Services 
  class AuthService {
    +authenticate(username, password)
    +getCurrentUser()
  }

  class GradebookService {
    +getGradebookForSection(sectionId, teacherId)
    +updateGrade(assignmentId, studentId, points, comment)
    +addFeedback(studentId, sectionId, comment, teacherId)
    +getGradesForStudent(studentId)
  }

  class AttendanceService {
    +getAttendanceForStudent(studentId)
    +markAttendance(sectionId, studentId, date, status, reason)
  }

  class HealthService {
    +getHealthVisits(studentId)
    +recordVisit(studentId, nurseId, notes)
  }

  class DisciplineService {
    +getDiscipline(studentId)
    +recordDiscipline(studentId, adminId, actionType, notes)
  }

  class AccessControlService {
    +authorize(userId, permission, resourceId)
    +permissionsForUser(userId)
  }

  class NotificationService {
    +notify(event)
    +list(userId)
    +markRead(notificationId)
  }

  class EnrollmentService {
    +enrollStudentInSection(studentId, sectionId, parentId, relationship)
  }

  class ReportingFacade {
    +buildAndExport(reportType, context, exportStrategy)
  }

  class DashboardService {
    +buildDashboardForStudent(studentId)
    +buildDashboardForParent(parentId)
  }

  class SearchService {
    +search(criteria, strategy)
  }

  class ExportService {
    +exportReport(reportType, exportStrategy)
  }

  ' Observer (Domain Events)
  class DomainEventBus {
    +subscribe(eventType, handler)
    +publish(event)
  }

  class GradesUpdated {
    +studentId: String
    +sectionId: String
  }

  class AttendanceUpdated {
    +studentId: String
  }

  class NurseVisitLogged {
    +studentId: String
  }

  class DisciplineRecorded {
    +studentId: String
  }

  interface NotificationRoutingStrategy {
    +recipientsFor(event)
  }

  class StudentParentRoutingStrategy {
    +recipientsFor(event)
  }

  'Strategy (Search & Export) 
  interface SearchStrategy {
    +match(item, criteria)
  }

  class ContainsSearchStrategy {
    +match(item, criteria)
  }

  class PrefixSearchStrategy {
    +match(item, criteria)
  }

  class ExactSearchStrategy {
    +match(item, criteria)
  }

  interface ExportStrategy {
    +render(data)
  }

  class CsvExportStrategy {
    +render(data)
  }

  class PdfExportStrategy {
    +render(data)
  }

  ' Simple Report type 
  class Report {
    +title: String
    +content: String
  }
}

' DATASOURCE 
package datasource {

  interface UserRepository {
    +findByUsername(username)
    +findById(id)
  }

  interface StudentRepository {
    +findById(id)
  }

  interface ParentRepository {
    +findById(id)
    +findByUserId(userId)
  }

  interface ParentStudentLinkRepository {
    +findByParentId(parentId)
  }

  interface TeacherRepository {
    +findById(id)
  }

  interface ClassRepository {
    +findById(id)
  }

  interface SectionRepository {
    +findById(id)
    +findByStudentId(studentId)
    +findByTeacherId(teacherId)
  }

  interface EnrollmentRepository {
    +findByStudentId(studentId)
    +save(enrollment)
  }

  interface AssignmentRepository {
    +findBySectionId(sectionId)
    +findById(id)
  }

  interface GradebookRepository {
    +findGradesForSection(sectionId)
    +findGradesForStudent(studentId)
    +saveGrade(gradeEntry)
  }

  interface FeedbackRepository {
    +findByStudentId(studentId)
    +saveFeedback(feedback)
  }

  interface AttendanceRepository {
    +findByStudentId(studentId)
    +saveAttendance(record)
  }

  interface HealthRepository {
    +findVisitsByStudentId(studentId)
    +saveVisit(visit)
  }

  interface DisciplineRepository {
    +findActionsByStudentId(studentId)
    +saveAction(action)
  }

  interface NotificationRepository {
    +findByUserId(userId)
    +save(notification)
    +markRead(notificationId)
  }

  interface RolePermissionRepository {
    +findByRole(role)
  }

  interface SessionRepository {
    +save(session)
    +findByToken(token)
    +delete(token)
  }

  interface AuditLogRepository {
    +append(event)
  }

  ' Example concrete implementations (optional)
  class SqlGradebookRepository
  class SqlAttendanceRepository
  class SqlHealthRepository
  class SqlDisciplineRepository
  class SqlNotificationRepository
  class SqlSessionRepository
}

' ARCHITECTURE ASSOCIATIONS 

'Presentation uses Domain
DashboardController ..> DashboardService
DashboardController ..> DashboardViewModel
DashboardController ..> StudentParentDashboardView

GradebookController ..> GradebookService
GradebookController ..> GradebookViewModel
GradebookController ..> TeacherGradebookView

AttendanceController ..> AttendanceService
AttendanceController ..> AttendanceViewModel
AttendanceController ..> AttendanceView

HealthController ..> HealthService
HealthController ..> HealthViewModel
HealthController ..> HealthView

DisciplineController ..> DisciplineService
DisciplineController ..> DisciplineViewModel
DisciplineController ..> DisciplineView

SearchController ..> SearchService
ExportController ..> ExportService
AuthController ..> AuthService
NotificationController ..> NotificationService
DashboardController ..> RefreshStrategy
LoginView ..> AuthController
NotificationView ..> NotificationController

' Views depend on ViewModels
StudentParentDashboardView ..> DashboardViewModel
TeacherGradebookView ..> GradebookViewModel
AttendanceView ..> AttendanceViewModel
HealthView ..> HealthViewModel
DisciplineView ..> DisciplineViewModel
NotificationView ..> NotificationViewModel

'Domain uses Datasource 
AuthService ..> UserRepository
AuthService ..> SessionRepository

DashboardService ..> StudentRepository
DashboardService ..> ParentRepository
DashboardService ..> ParentStudentLinkRepository
DashboardService ..> SectionRepository
DashboardService ..> GradebookRepository
DashboardService ..> AttendanceRepository
DashboardService ..> FeedbackRepository
DashboardService ..> HealthRepository
DashboardService ..> DisciplineRepository

GradebookService ..> GradebookRepository
GradebookService ..> AssignmentRepository
GradebookService ..> FeedbackRepository
GradebookService ..> DomainEventBus

EnrollmentService ..> EnrollmentRepository
EnrollmentService ..> ParentStudentLinkRepository

AttendanceService ..> AttendanceRepository
AttendanceService ..> DomainEventBus

HealthService ..> HealthRepository
HealthService ..> DomainEventBus

DisciplineService ..> DisciplineRepository
DisciplineService ..> DomainEventBus

AccessControlService ..> RolePermissionRepository
AccessControlService ..> UserRepository

NotificationService ..> NotificationRepository
NotificationService ..> DomainEventBus
NotificationService ..> NotificationRoutingStrategy

SearchService ..> SearchStrategy
ExportService ..> ExportStrategy
ReportingFacade ..> DashboardService
ReportingFacade ..> ExportService
ReportingFacade ..> NotificationService

DomainEventBus ..> AuditLogRepository

'Strategy implementations
ContainsSearchStrategy ..|> SearchStrategy
PrefixSearchStrategy ..|> SearchStrategy
ExactSearchStrategy ..|> SearchStrategy

CsvExportStrategy ..|> ExportStrategy
PdfExportStrategy ..|> ExportStrategy
StudentParentRoutingStrategy ..|> NotificationRoutingStrategy
PushRefreshStrategy ..|> RefreshStrategy
PollingRefreshStrategy ..|> RefreshStrategy

'Example  repos implementing interfaces
SqlGradebookRepository ..|> GradebookRepository
SqlAttendanceRepository ..|> AttendanceRepository
SqlHealthRepository ..|> HealthRepository
SqlDisciplineRepository ..|> DisciplineRepository
SqlNotificationRepository ..|> NotificationRepository
SqlSessionRepository ..|> SessionRepository

'DOMAIN RELATIONSHIPS (ARROWS) 

' Users / roles / links
Parent -- ParentStudentLink
Student -- ParentStudentLink
Session -- User

Section -- Class
Section -- Teacher

Enrollment -- Student
Enrollment -- Section

' Grades & feedback
Assignment -- Section
GradeEntry -- Assignment
GradeEntry -- Student

Feedback -- Student
Feedback -- Section
Feedback -- Teacher

' Attendance / health / discipline
AttendanceRecord -- Student
AttendanceRecord -- Section

NurseVisit -- Student
NurseVisit -- Nurse

DisciplineAction -- Student
DisciplineAction -- Administrator

' Domain events to the entities they concern
GradesUpdated -- Student
GradesUpdated -- Section

AttendanceUpdated -- Student
NurseVisitLogged -- Student
DisciplineRecorded -- Student

'NEW: User-related arrows
UserRepository ..> User
RolePermissionRepository ..> RolePermission

Student ..> User
Parent ..> User
Teacher ..> User
Nurse ..> User
Administrator ..> User
Notification ..> User

@enduml
